<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>æ°´ç­èƒ½é‡ç«™</title>
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-pink: #ff85a2; --bg: #fff9fa; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { width: 310px; background: white; border-radius: 35px; padding: 30px; box-shadow: 0 15px 40px rgba(255,133,162,0.1); text-align: center; position: relative; }
        .logo { font-size: 70px; margin-bottom: 20px; }
        h2 { color: var(--primary-pink); font-size: 20px; margin: 0 0 15px; }
        input { width: 100%; border: none; background: #fef0f3; padding: 18px; border-radius: 20px; font-size: 20px; text-align: center; box-sizing: border-box; outline: none; color: var(--primary-pink); letter-spacing: 3px; font-weight: bold; }
        .btn-go { width: 100%; background: var(--primary-pink); color: white; border: none; padding: 18px; border-radius: 50px; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 25px; box-shadow: 0 6px #ffdae3; }
        
        /* æ¢å¤å¤‡ä»½åŒºåŸŸæ ·å¼ */
        .recovery-link { margin-top: 25px; font-size: 13px; color: #bbb; cursor: pointer; text-decoration: underline; transition: color 0.3s; }
        .recovery-link:hover { color: var(--primary-pink); }
        
        #guide-box { display: none; }
        .instruction { text-align: left; background: #fff9fa; padding: 20px; border-radius: 20px; margin: 20px 0; font-size: 13px; color: #777; line-height: 1.8; }
        .highlight { color: var(--primary-pink); font-weight: bold; }
        .lang-toggle { position: absolute; top: 15px; right: 20px; font-size: 12px; color: var(--primary-pink); font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="lang-toggle" onclick="toggleLang()" id="lang-btn">EN</div>

    <div id="auth-ui">
        <div class="logo">ğŸ¦¦</div>
        <h2 id="t-auth-title">æ¿€æ´»æ‚¨çš„èƒ½é‡ç«™</h2>
        <input type="text" id="activation-code" placeholder="ENTER CODE">
        <button class="btn-go" onclick="handleVerify()" id="t-auth-btn">ç«‹å³éªŒè¯</button>
        
        <div class="recovery-link" onclick="document.getElementById('restore-file').click()" id="t-recover">
            é€šè¿‡å¤‡ä»½æ–‡ä»¶å¤åŸæ•°æ®
        </div>
        <input type="file" id="restore-file" accept=".json" onchange="importStellarockData(event)" style="display:none;">
    </div>

    <div id="guide-box">
        <div class="logo">ğŸ“±</div>
        <h2 id="t-guide-title">ä½¿ç”¨è¯´æ˜</h2>
        <div class="instruction" id="t-instruction">
            1ï¸âƒ£ ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨çš„ <span class="highlight">åˆ†äº«æŒ‰é’®</span> (æ–¹å—ç®­å¤´)<br>
            2ï¸âƒ£ å‘ä¸Šæ»‘åŠ¨æ‰¾åˆ° <span class="highlight">â€œæ·»åŠ åˆ°ä¸»å±å¹•â€</span><br>
            3ï¸âƒ£ ç‚¹å‡»å³ä¸Šè§’ <span class="highlight">â€œæ·»åŠ â€</span><br><br>
            å®Œæˆåä»æ¡Œé¢å›¾æ ‡è¿›å…¥ã€‚
        </div>
        <button class="btn-go" onclick="enterApp()" id="t-guide-btn">è¿›å…¥ç³»ç»Ÿ</button>
    </div>
</div>

<script>

    if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('é—¨ç¦ç®¡å®¶å·²å°±ä½', reg.scope))
            .catch(err => console.log('ç®¡å®¶ç½¢å·¥äº†', err));
    });
}

    const PRIVATE_SALT = "INTJ_ARCHITECT_2026_PRO";

    let currentLang = localStorage.getItem('lang') || 'zh';

    const translations = {
        'zh': {
            'btn': 'EN',
            'authTitle': 'æ¿€æ´»æ‚¨çš„èƒ½é‡ç«™',
            'authBtn': 'ç«‹å³éªŒè¯',
            'recover': 'é€šè¿‡å¤‡ä»½æ–‡ä»¶å¤åŸæ•°æ®',
            'guideTitle': 'ä½¿ç”¨è¯´æ˜',
            'guideBtn': 'è¿›å…¥ç³»ç»Ÿ',
            'instruction': 'ä¸ºäº†è·å¾— <span class="highlight">APP</span> ä½“éªŒï¼š<br><br>1ï¸âƒ£ ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨çš„ <span class="highlight">åˆ†äº«æŒ‰é’®</span><br>2ï¸âƒ£ å‘ä¸Šæ»‘åŠ¨æ‰¾åˆ° <span class="highlight">â€œæ·»åŠ åˆ°ä¸»å±å¹•â€</span><br>3ï¸âƒ£ ç‚¹å‡»å³ä¸Šè§’ <span class="highlight">â€œæ·»åŠ â€</span><br><br>å®Œæˆåä»æ¡Œé¢å›¾æ ‡è¿›å…¥ã€‚',
            'error': 'æ¿€æ´»ç é”™è¯¯ğŸ¦¦',
            'importSuccess': 'âœ… èµ„äº§è¿˜åŸæˆåŠŸï¼Œæ¬¢è¿å›æ¥ï¼',
            'importError': 'âŒ æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶ã€‚'
        },
        'en': {
            'btn': 'ä¸­æ–‡',
            'authTitle': 'Activate Station',
            'authBtn': 'Verify Now',
            'recover': 'Restore from Backup File',
            'guideTitle': 'Instructions',
            'guideBtn': 'Enter System',
            'instruction': 'To <span class="highlight">App Experience</span>:<br><br>1ï¸âƒ£ Click the <span class="highlight">Share Icon</span><br>2ï¸âƒ£ Tap <span class="highlight">"Add to Home Screen"</span><br>3ï¸âƒ£ Tap <span class="highlight">"Add"</span> on the top right.<br><br>Then open from home screen.',
            'error': 'Invalid Code. ğŸ¦¦',
            'importSuccess': 'âœ… Assets Restored! Welcome back.',
            'importError': 'âŒ Invalid Backup File.'
        }
    };
    
    
    function updateUI() {
        const t = translations[currentLang];
        document.getElementById('lang-btn').innerText = t.btn;
        document.getElementById('t-auth-title').innerText = t.authTitle;
        document.getElementById('t-auth-btn').innerText = t.authBtn;
        document.getElementById('t-recover').innerText = t.recover;
        document.getElementById('t-guide-title').innerText = t.guideTitle;
        document.getElementById('t-guide-btn').innerText = t.guideBtn;
        document.getElementById('t-instruction').innerHTML = t.instruction;
    }

    function toggleLang() {
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        localStorage.setItem('lang', currentLang);
        updateUI();
    }

    function generateDeviceFingerprint() {
        const info = [
            navigator.userAgent,
            screen.width + "x" + screen.height,
            navigator.language
        ].join('|');
        let hash = 0;
        for (let i = 0; i < info.length; i++) {
            hash = ((hash << 5) - hash) + info.charCodeAt(i);
            hash |= 0;
        }
        return Math.abs(hash).toString(36).toUpperCase();
    }

    async function validateLicense(code) {
        if (!code || code.length !== 20) return false;
        const prefix = code.substring(0,12).toUpperCase();
        const suffix = code.substring(12).toLowerCase();
        const msgUint8 = new TextEncoder().encode(prefix + PRIVATE_SALT);
        const hashBuffer = await crypto.subtle.digest('SHA-256',msgUint8);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const expectedSuffix = hashArray.map(b => b.toString(16).padStart(2,'0')).join('').substring(0,8);

        return suffix === expectedSuffix;
    }
    
    async function handleVerify() {
        const input = document.getElementById('activation-code');
        const btn = document.getElementById('t-auth-btn');
        if (btn.disabled) return;
        
        const code = input.value.trim().toUpperCase();
        const isValid = await validateLicense(code);
      
        if (isValid) {
            try {
                btn.disabled = true;
                const deviceID = generateDeviceFingerprint();
                const WORKER_URL = 'https://stellarock-auth.jingyi950917.workers.dev';
                const response = await fetch(WORKER_URL,{
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code,deviceID })
                });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
            localStorage.setItem('isActivated', 'true');
            localStorage.setItem('license_key', code);
            localStorage.setItem('bound_device_id',generateDeviceFingerprint());
            
            showGuide();
        } else {
            alert(translations[currentLang].error);
                    btn.disabled = false;
        }
            } catch (err) {
                alert(currentLang === 'zh' ? "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥" : "Network required.");
                btn.disabled = false;
            }
        } else {
            alert(translations[currentLang].error);
           
        }
    }

    // --- æ•°æ®èµ„äº§è¿˜åŸæ ¸å¿ƒå¼•æ“ ---
    function importStellarockData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ Stellarock å¤‡ä»½ï¼ˆå¿…é¡»åŒ…å«æ¿€æ´»æ ‡è®°æˆ–å†å²æ•°æ®ï¼‰
                if (data.isActivated === 'true' || data.revenue_history) {
                    localStorage.clear();
                    for (let key in data) {
                        localStorage.setItem(key, data[key]);
                    }
                    // å¼ºåˆ¶ç¡®ä¿æ¿€æ´»çŠ¶æ€
                    localStorage.setItem('isActivated', 'true');
                    alert(translations[currentLang].importSuccess);
                    enterApp(); // ç›´æ¥è¿›å…¥ï¼Œæ— éœ€çœ‹å¼•å¯¼
                } else {
                    throw new Error();
                }
            } catch (err) {
                alert(translations[currentLang].importError);
            }
        };
        reader.readAsText(file);
    }

    function showGuide() {
        document.getElementById('auth-ui').style.display = 'none';
        document.getElementById('guide-box').style.display = 'block';
    }

    function enterApp() {
        window.location.replace('index.html');
    }

    if (localStorage.getItem('isActivated') === 'true') {
        // å¦‚æœå·²æ¿€æ´»ï¼Œç›´æ¥è¿›å¼•å¯¼é¡µï¼ˆæˆ–ç›´æ¥è¿›Appï¼Œæ ¹æ®ä½ çš„PMé€»è¾‘å†³å®šï¼‰
        showGuide();
    }
    updateUI();
</script>
</body>
</html>
